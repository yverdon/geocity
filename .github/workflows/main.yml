name: Geocity CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Build/Pull Containers
      run: cp env.demo .env && docker-compose -f docker-compose-dev.yml build
    - name: Run Containers
      run: docker-compose -f docker-compose-dev.yml down --remove-orphans && docker-compose -f docker-compose-dev.yml up -d
    - name: Sanity Checks
      run: |
        WEB_OK=$(docker ps -aq --filter status="running" --filter name="geocity_web_1") && if [ -z "$WEB_OK" ]; then exit 1; fi
        POSTGRES_OK=$(docker ps -aq --filter status="running" --filter name="geocity_postgres_1") && if [ -z "$POSTGRES_OK" ]; then exit 1; fi
        QGISSERVER_OK=$(docker ps -aq --filter status="running" --filter name="geocity_qgisserver_1") && if [ -z "$QGISSERVER_OK" ]; then exit 1; fi
    - name: "Lint Code"
      run: docker-compose exec -T web black . --check
    - name: "Test Code"
      run: docker-compose exec -T web ./run_tests.sh
    - name: Stop Containers
      run: docker-compose down --remove-orphans

  push_to_registry:
    name: Push Docker image to Docker Hub
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v2
      - name: Push to Docker Hub
        uses: docker/build-push-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
          repository: sitdocker/geocity
          tag_with_ref: true
