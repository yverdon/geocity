{% if id != 'id_form-__prefix__-geom' %}
{# Adapted from django gis contrib #}

{% load i18n l10n %}
{% load static %}
{% load submissions_extras %}

{% block scripts %}
<script type="module" src="{% static 'libs/js/advanced-geometry-edition/geocity-wc-map.js' %}"></script>
{% endblock %}

<div id="geometry-widget-{{ id }}" data-initialize="{% if "__prefix__" in id %}0{% else %}1{% endif %}" data-map-target="{{ id }}_map" data-options="{{ options|json }}" data-geometry-widget >
  <div style="width: 100%; height: 80vh;margin-left: auto;margin-right: auto" id="web-component-advanced">
  </div>
  <textarea id="{{ id }}" class="vSerializedField required{% if not display_raw %} d-none{% endif %}" cols="150" rows="10" name="{{ name }}" data-role="serialized">{{ serialized }}</textarea>
</div>

<script>
  const optionsDiv = document.querySelectorAll("[data-geometry-widget]:not([data-initialize='0'])")
  if (optionsDiv && optionsDiv[0] && optionsDiv[0].dataset && optionsDiv[0].dataset.options) {
    const options = JSON.parse(optionsDiv[0].dataset.options);
    if (options && options.map_widget_configuration) {
      const componentDiv = document.getElementById('web-component-advanced');
        if (componentDiv) {
          const wc = document.createElement('openlayers-element');
          wc.options = options.map_widget_configuration[0];
          componentDiv.appendChild(wc);
        }
    }
  }

  window.addEventListener('position-selected', (event) => {
        const serialized = document.querySelector("[data-role='serialized']");
        if (event.detail && serialized) {
            serialized.value = event.detail;
        } else {
          serialized.value = '';
        }
    })
</script>
{% endif %}
